---
title: "Хакатон 2026"
author: "Oksana Plastinina"
date: "`r Sys.Date()`"
output: officedown::rdocx_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(officedown)
```

```{r}
data <- read.csv('team3_ecrf_wide.csv')
```

```{r}
data <- data %>% 
  mutate(
    across(c(ARM, V0_DEM_SEX, contains('ABN'), contains('PASS')), as.factor)
  )
```

# Оценка данных

```{r}
#skimr::skim(data)
```


# Очистка данных

```{r}
# проверка на соответствие критериям включения и невключения
data %>% 
  filter(V0_DEM_AGE <= 65 & V0_DEM_AGE >= 18) %>% 
  filter(V0_DAS_DAS28 > 3.2) %>% 
  filter(V0_BIO_ALT < 250 & V0_BIO_AST < 250) %>% 
  filter(V0_BIO_CREAT < 5) %>% 
  filter(V0_CBC_HGB > 8) %>% 
  filter(V0_CBC_WBC > 4 & V0_CBC_PLT > 150) %>% 
  filter(V0_VIT_BP_ABN == 0) %>% 
  filter(V0_BIO_CRP < 80)-> data_cleaned


 check_visits <- function(data) {
  
  for(v in 0:12) {
    hgb_col <- paste0("V", v, "_CBC_HGB")
    wbc_col <- paste0("V", v, "_CBC_WBC")
    plt_col <- paste0("V", v, "_CBC_PLT")
    alt_col <- paste0("V", v, "_BIO_ALT")
    ast_col <- paste0("V", v, "_BIO_AST")
    creat_col <- paste0("V", v, "_BIO_CREAT")
    crp_col <- paste0("V", v, "_BIO_CRP")
    bp_col <- paste0("V", v, "_VIT_BP_ABN")
    
   {
      data <- data %>%
        filter(
          .data[[hgb_col]] >= 8,
          .data[[wbc_col]] >= 4,
          .data[[plt_col]] >= 150,
          .data[[alt_col]] < 250,
          .data[[ast_col]] < 250,
          .data[[creat_col]] < 5,
          .data[[crp_col]] < 100,
        )
      
      cat("После визита V", v, " осталось пациентов: ", nrow(data), "\n")
    }
  }
  return(data)
}
data_ready <- check_visits(data_cleaned)

  
```

```{r}
data_cleaned %>% 
  mutate("TS" = 1) -> data_cleaned

left_join(data, data_cleaned) -> data_with_flag

data_with_flag %>% 
  relocate(TS, .before = everything()) %>% 
  mutate(TS = ifelse(is.na(TS), 0, 1)) -> data_with_flag
```


# Анализ первичной конечной точки

На основании первичной конечной точки можно сформулировать тестируемые гипотезы:

**Нулевая гипотеза:** Разница средних между группами КуркуминаНЕО и метотрексата меньше или равна порогу не меньшей эффективности. (то есть КуркуминНЕО имеет такой же или даже более выраженный эффект)

**Альтернативная гипотеза:** Разница средних между группами КуркуминаНЕО и метотрексата больше порога не меньшей эффективности. (то есть КуркуминНЕО имеет клинически значимо меньший эффект, чем метотрексат)

$Н0: \Delta DAS28_{curcumin} - \Delta DAS28_{methotrexate}  \leq  \delta$

$HA: \Delta DAS28_{curcumin}  - \Delta DAS28_{methotrexate}   >\delta$

Где $\delta$ - порог не меньшей эффективности, равный -0.6 баллов по шкале DAS28,
$\Delta$ - разница между баллами за 12 и 0 визиты у пациента 


```{r}
data_ready %>% 
  mutate("delta_DAS28" = V12_DAS_DAS28 - V0_DAS_DAS28) -> data_ready  # чем меньше, тем лучше

ggplot(data_ready) +
  geom_boxplot(aes(x = ARM, y = delta_DAS28, fill = ARM))+
  theme_minimal()

```

```{r}
t_test_pkt <- t.test(delta_DAS28~ARM, data = data_ready, conf.level = 0.975, alternative = "greater", mu = -0.6)
```

По результатам выполнения функции средняя разница между группами (КуркуминНЕО - Метотрексат) составила 0.704 балла по шкале DAS28 95%CI [0.4419774 Inf] (р-value = 5.291e-10), что значительно превышает порог не меньшей эффективности, равный -0.6 баллов по шкале DAS28, следовательно мы отвергаем нулевую гипотезу о том, что КуркуминНЕО имеет такой же или более выраженный эффект, чем метотрексат. 


Дополнительно эффект каждого препарата в отдельности
```{r}
data_ready %>% 
  filter(ARM == "Methotrexate") -> data_mtx


t_test_mtx <- t.test(data_mtx$V0_DAS_DAS28, data_mtx$V12_DAS_DAS28, paired = TRUE)

data_ready %>% 
  filter(ARM == "CurcuminNEO") -> data_crc

t_test_crc <- t.test(data_crc$V0_DAS_DAS28, data_crc$V12_DAS_DAS28, paired = T)

```

# Анализ вторичных конечных точек

1. Изменение доли пациентов, достигших полного ответа (на основе DAS28 < 2.6)
```{r}
ggplot(data_ready) +
  geom_col(aes(x = ARM, y = V0_DAS_DAS28))

data_ready %>% 
  filter(ARM == "CurcuminNEO") %>% 
  filter(V12_DAS_DAS28 < 2.6)

data_ready %>% 
  filter(ARM == "Methotrexate") %>% 
  filter(V12_DAS_DAS28 < 2.6)

table_DAS28_crc <- matrix(
  c(0, 10, 
    0, 10), nrow = 2, byrow = T,
dimnames = list(c("0 визит", "12 визит"), c("DAS28 < 2.6", "DAS28 > 2.6")))

table_DAS28_mtx <- matrix(
  c(0, 13, 
    5, 8), nrow = 2, byrow = T,
dimnames = list(c("0 визит", "12 визит"), c("DAS28 < 2.6", "DAS28 > 2.6")))

chisq.test(table_DAS28_mtx)



```



